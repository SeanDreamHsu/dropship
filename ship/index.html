<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shipping Fee Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Shipment Details</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Sender Address Section -->
            <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                <h2 class="text-xl font-semibold text-blue-700 mb-4">Sender Information (Origin)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="senderName" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="senderName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Sender's Name" required>
                    </div>
                    <div>
                        <label for="senderStreet1" class="block text-sm font-medium text-gray-700">Street 1</label>
                        <input type="text" id="senderStreet1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="123 Main St" required>
                    </div>
                    <div>
                        <label for="senderCity" class="block text-sm font-medium text-gray-700">City</label>
                        <input type="text" id="senderCity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Anytown" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="senderState" class="block text-sm font-medium text-gray-700">State</label>
                            <input type="text" id="senderState" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="CA" required>
                        </div>
                        <div>
                            <label for="senderZip" class="block text-sm font-medium text-gray-700">Zip Code</label>
                            <input type="text" id="senderZip" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="90210" required>
                        </div>
                    </div>
                    <div>
                        <label for="senderCountry" class="block text-sm font-medium text-gray-700">Country (2-letter ISO code, e.g., US)</label>
                        <input type="text" id="senderCountry" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="US" required>
                    </div>
                </div>
            </div>

            <!-- Receiver Address Section -->
            <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                <h2 class="text-xl font-semibold text-green-700 mb-4">Receiver Information (Destination)</h2>
                <div class="space-y-4">
                    <div>
                        <label for="receiverName" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="receiverName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Receiver's Name" required>
                    </div>
                    <div>
                        <label for="receiverStreet1" class="block text-sm font-medium text-gray-700">Street 1</label>
                        <input type="text" id="receiverStreet1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="456 Oak Ave" required>
                    </div>
                    <div>
                        <label for="receiverCity" class="block text-sm font-medium text-gray-700">City</label>
                        <input type="text" id="receiverCity" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Otherville" required>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="receiverState" class="block text-sm font-medium text-gray-700">State</label>
                            <input type="text" id="receiverState" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="NY" required>
                        </div>
                        <div>
                            <label for="receiverZip" class="block text-sm font-medium text-gray-700">Zip Code</label>
                            <input type="text" id="receiverZip" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="10001" required>
                        </div>
                    </div>
                    <div>
                        <label for="receiverCountry" class="block text-sm font-medium text-gray-700">Country (2-letter ISO code, e.g., US)</label>
                        <input type="text" id="receiverCountry" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="US" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item Details Section -->
        <div class="bg-purple-50 p-6 rounded-lg border border-purple-200 mb-8">
            <h2 class="text-xl font-semibold text-purple-700 mb-4">Item Details</h2>
            <div class="space-y-4">
                <div>
                    <label for="itemDescription" class="block text-sm font-medium text-gray-700">Item Description</label>
                    <input type="text" id="itemDescription" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="e.g., T-shirt, Book, Gadget">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="itemWeight" class="block text-sm font-medium text-gray-700">Weight (lbs)</label>
                        <input type="number" id="itemWeight" step="0.01" min="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="e.g., 1.5" required>
                    </div>
                    <div>
                        <label for="itemLength" class="block text-sm font-medium text-gray-700">Length (in)</label>
                        <input type="number" id="itemLength" step="0.01" min="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="e.g., 10" required>
                    </div>
                    <div>
                        <label for="itemWidth" class="block text-sm font-medium text-gray-700">Width (in)</label>
                        <input type="number" id="itemWidth" step="0.01" min="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="e.g., 8" required>
                    </div>
                    <div>
                        <label for="itemHeight" class="block text-sm font-medium text-gray-700">Height (in)</label>
                        <input type="number" id="itemHeight" step="0.01" min="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" placeholder="e.g., 5" required>
                    </div>
                </div>
                <div>
                    <label for="packageType" class="block text-sm font-medium text-gray-700">Package Type</label>
                    <select id="packageType" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm" required>
                        <option value="">Select Package Type</option>
                        <option value="package">Package</option>
                        <option value="flat_rate_envelope">Flat Rate Envelope</option>
                        <option value="large_envelope">Large Envelope</option>
                        <option value="small_flat_rate_box">Small Flat Rate Box</option>
                        <option value="medium_flat_rate_box">Medium Flat Rate Box</option>
                        <option value="large_flat_rate_box">Large Flat Rate Box</option>
                        <option value="regional_rate_box_a">Regional Rate Box A</option>
                        <option value="regional_rate_box_b">Regional Rate Box B</option>
                        <option value="padded_flat_rate_envelope">Padded Flat Rate Envelope</option>
                        <option value="legal_flat_rate_envelope">Legal Flat Rate Envelope</option>
                        <option value="one_rate_pak">One Rate Pak</option>
                        <option value="one_rate_medium_box">One Rate Medium Box</option>
                        <!-- Add more package types as needed, referring to ShipStation API docs -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Shipping Carrier and Service Section -->
        <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200 mb-8">
            <h2 class="text-xl font-semibold text-yellow-700 mb-4">Shipping Carrier & Service</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="shippingCarrier" class="block text-sm font-medium text-gray-700">Carrier</label>
                    <select id="shippingCarrier" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm" required>
                        <option value="">Select Carrier</option>
                        <option value="stamps_com">USPS (Stamps.com)</option>
                        <option value="ups">UPS</option>
                        <option value="fedex">FedEx</option>
                        <!-- Add more carriers as needed, referring to ShipStation API docs for exact codes -->
                    </select>
                </div>
                <div>
                    <label for="shippingServiceLabel" class="block text-sm font-medium text-gray-700">Service Code</label>
                    <!-- This div will hold either a select or an input based on carrier -->
                    <div id="shippingServiceContainer" class="mt-1">
                        <input type="text" id="shippingService" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm" placeholder="e.g., usps_priority_mail" required>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculate Button -->
        <div class="text-center">
            <button id="calculateBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition duration-300 ease-in-out hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                Calculate Shipping Fee
            </button>
        </div>

        <!-- Message Box for output -->
        <div id="messageBox" class="mt-8 p-4 bg-gray-100 rounded-md text-gray-700 hidden">
            <p id="messageText" class="font-medium"></p>
        </div>
    </div>

    <script>
        const shippingCarrierSelect = document.getElementById('shippingCarrier');
        const shippingServiceContainer = document.getElementById('shippingServiceContainer');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Define FedEx specific services
        const fedexServices = [
            { value: "", text: "Select FedEx Service" }, // Added default empty option for FedEx
            { value: "fedex_express_2_day", text: "FedEx Express 2 Day" },
            { value: "fedex_ground", text: "FedEx Ground (Commercial)" },
            { value: "fedex_home_delivery", text: "FedEx Home Delivery (Residential)" }
        ];

        function updateShippingServiceOptions() {
            const selectedCarrier = shippingCarrierSelect.value;
            shippingServiceContainer.innerHTML = ''; // Clear existing content

            if (selectedCarrier === 'fedex') {
                const selectElement = document.createElement('select');
                selectElement.id = 'shippingService';
                selectElement.className = 'block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm';
                selectElement.setAttribute('required', 'true'); // Ensure required for dynamically created select

                fedexServices.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.value;
                    option.textContent = service.text;
                    selectElement.appendChild(option);
                });
                shippingServiceContainer.appendChild(selectElement);
            } else {
                const inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.id = 'shippingService';
                inputElement.className = 'block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm';
                inputElement.placeholder = 'e.g., usps_priority_mail';
                inputElement.setAttribute('required', 'true'); // Ensure required for dynamically created input
                shippingServiceContainer.appendChild(inputElement);
            }
        }

        // Initial call to set up the correct input type on load
        updateShippingServiceOptions();

        // Event listener for carrier selection change
        shippingCarrierSelect.addEventListener('change', updateShippingServiceOptions);


        document.getElementById('calculateBtn').addEventListener('click', async function() {
            messageBox.classList.add('hidden'); // Hide previous messages
            messageText.textContent = ''; // Clear message text

            // Show a loading message
            messageText.textContent = "Calculating shipping fee...";
            messageBox.classList.remove('hidden');
            messageBox.classList.remove('bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            messageBox.classList.add('bg-gray-200', 'text-gray-800');


            // Gather Sender Information
            const senderAddress = {
                name: document.getElementById('senderName').value.trim(),
                street1: document.getElementById('senderStreet1').value.trim(),
                city: document.getElementById('senderCity').value.trim(),
                state: document.getElementById('senderState').value.trim(),
                postalCode: document.getElementById('senderZip').value.trim(),
                country: document.getElementById('senderCountry').value.trim(), // Trim country input
                residential: false // Assuming sender is commercial
            };

            // Gather Receiver Information
            const receiverAddress = {
                name: document.getElementById('receiverName').value.trim(),
                street1: document.getElementById('receiverStreet1').value.trim(),
                city: document.getElementById('receiverCity').value.trim(),
                state: document.getElementById('receiverState').value.trim(),
                postalCode: document.getElementById('receiverZip').value.trim(),
                country: document.getElementById('receiverCountry').value.trim(), // Trim country input
                residential: true // Assuming receiver is residential
            };

            // Gather Item Details
            const itemDescription = document.getElementById('itemDescription').value.trim();
            const itemWeight = parseFloat(document.getElementById('itemWeight').value);
            const itemLength = parseFloat(document.getElementById('itemLength').value);
            const itemWidth = parseFloat(document.getElementById('itemWidth').value);
            const itemHeight = parseFloat(document.getElementById('itemHeight').value);
            const packageType = document.getElementById('packageType').value; // Get package type

            // Gather Carrier and Service Details
            const shippingCarrier = shippingCarrierSelect.value;
            const shippingService = document.getElementById('shippingService').value.trim(); // Trim service input


            // Enhanced Basic validation
            let validationErrors = [];

            // Check if any address field is empty for sender
            if (Object.values(senderAddress).some(val => typeof val === 'string' && val === '')) {
                validationErrors.push("All sender address fields (Name, Street, City, State, Zip, Country) are required.");
            }
            // Check if sender country is not a 2-letter code
            if (senderAddress.country.length !== 2 || !/^[A-Z]{2}$/.test(senderAddress.country.toUpperCase())) {
                validationErrors.push("Sender Country must be a 2-letter ISO code (e.g., US).");
            }

            // Check if any address field is empty for receiver
            if (Object.values(receiverAddress).some(val => typeof val === 'string' && val === '')) {
                validationErrors.push("All receiver address fields (Name, Street, City, State, Zip, Country) are required.");
            }
            // Check if receiver country is not a 2-letter code
            if (receiverAddress.country.length !== 2 || !/^[A-Z]{2}$/.test(receiverAddress.country.toUpperCase())) {
                validationErrors.push("Receiver Country must be a 2-letter ISO code (e.g., US).");
            }

            if (isNaN(itemWeight) || itemWeight <= 0) {
                validationErrors.push("Weight must be a positive number (e.g., 0.1 or more).");
            }
            if (isNaN(itemLength) || itemLength <= 0 || isNaN(itemWidth) || itemWidth <= 0 || isNaN(itemHeight) || itemHeight <= 0) {
                validationErrors.push("Length, Width, and Height must be positive numbers (e.g., 0.01 or more).");
            }
            if (!packageType) {
                validationErrors.push("Please select a Package Type.");
            }
            if (!shippingCarrier) {
                validationErrors.push("Please select a Shipping Carrier.");
            }
            if (!shippingService) {
                validationErrors.push("Please select or enter a Service Code.");
            }

            if (validationErrors.length > 0) {
                messageText.innerHTML = "Please correct the following issues:<br>" + validationErrors.join("<br>");
                messageBox.classList.remove('bg-gray-200', 'text-gray-800');
                messageBox.classList.add('bg-red-100', 'text-red-700');
                return;
            }

            const packageDetails = {
                weight: {
                    value: itemWeight,
                    units: "pounds"
                },
                dimensions: {
                    length: itemLength,
                    width: itemWidth,
                    height: itemHeight,
                    units: "inches"
                },
                packageType: packageType,
                insuredValue: 0.0,
                contents: itemDescription
            };

            // The payload to send to your Flask backend
            const payloadToSendToBackend = {
                from: senderAddress,
                to: receiverAddress,
                package: packageDetails,
                carrierCode: shippingCarrier,
                serviceCode: shippingService,
                testMode: true
            };

            console.log("[Frontend] Sending payload to backend:");
            console.log(JSON.stringify(payloadToSendToBackend, null, 2));

            try {
                // Make the fetch request to your Flask backend
                const response = await fetch('http://127.0.0.1:5000/calculate-shipping', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payloadToSendToBackend),
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    messageText.textContent = `Estimated Shipping Fee: $${data.fee.toFixed(2)}`;
                    messageBox.classList.remove('bg-gray-200', 'text-gray-800', 'bg-red-100', 'text-red-700');
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                    console.log("[Frontend] Received successful response from backend:", data);
                } else {
                    messageText.textContent = `Error calculating shipping: ${data.message || 'Unknown error'}`;
                    messageBox.classList.remove('bg-gray-200', 'text-gray-800', 'bg-green-100', 'text-green-700');
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                    console.error("[Frontend] Error response from backend:", data);
                }
            } catch (error) {
                console.error('[Frontend] Fetch error:', error);
                messageText.textContent = `Network error or backend not running: ${error.message}. Please ensure the Python backend is running.`;
                messageBox.classList.remove('bg-gray-200', 'text-gray-800', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'text-red-700');
            }
        });
    </script>
</body>
</html>
